<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Profile</title>
	<link th:href="@{/css/profile.css}" rel="stylesheet" />
</head>

<body>
	<div class="container">
		<div class="card">
			<h1 class="title">プロフィール情報</h1>

			<!-- USERNAME -->
			<div class="profile-group">
				<label>ユーザー名</label>
				<div class="profile-value">ryu1905</div>
				<input class="profile-input" type="text" name="username" hidden>
			</div>

			<!-- EMAIL -->
			<div class="profile-group">
				<label>メールアドレス</label>
				<div class="profile-value">example@gmail.com</div>
				<input class="profile-input" type="email" name="email" hidden>
			</div>

			<!-- BUTTONS -->
			<div class="btn-group">
				<button id="editBtn" class="btn edit" onclick="toggleEdit()">編集</button>
				<button id="saveBtn" class="btn edit" onclick="saveEdit()" hidden>保存</button>
				<button id="cancelBtn" class="btn back" onclick="cancelEdit()" hidden>キャンセル</button>
				<button class="btn back" onclick="goBack()">戻る</button>
			</div>
		</div>
	</div>

	<script>
		/* =====================
		   EDIT MODE
		===================== */
		function toggleEdit() {
			document.querySelectorAll(".profile-group").forEach(group => {
				const value = group.querySelector(".profile-value");
				const input = group.querySelector(".profile-input");

				input.value = value.textContent.trim();
				value.hidden = true;
				input.hidden = false;
			});

			document.getElementById("editBtn").hidden = true;
			document.getElementById("saveBtn").hidden = false;
			document.getElementById("cancelBtn").hidden = false;
		}

		/* =====================
		   CANCEL
		===================== */
		function cancelEdit() {
			document.querySelectorAll(".profile-group").forEach(group => {
				const value = group.querySelector(".profile-value");
				const input = group.querySelector(".profile-input");

				input.setCustomValidity("");
				input.hidden = true;
				value.hidden = false;
			});

			document.getElementById("editBtn").hidden = false;
			document.getElementById("saveBtn").hidden = true;
			document.getElementById("cancelBtn").hidden = true;
		}

		/* =====================
		   SAVE
		===================== */
		function saveEdit() {
			const inputs = document.querySelectorAll(".profile-input");

			if (!validateInputs(inputs)) {
				return; // ❌ chỉ chặn tại đây
			}

			document.querySelectorAll(".profile-group").forEach(group => {
				const value = group.querySelector(".profile-value");
				const input = group.querySelector(".profile-input");

				value.textContent = input.value;
				input.hidden = true;
				value.hidden = false;
			});

			document.getElementById("editBtn").hidden = false;
			document.getElementById("saveBtn").hidden = true;
			document.getElementById("cancelBtn").hidden = true;

			// TODO: gọi API save ở đây
		}

		/* =====================
		   VALIDATION
		===================== */
		function validateInputs(inputs) {

			const asciiRegex = /^[\x00-\x7F]+$/;
			const emailRegex = /^[A-Za-z0-9._-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/;
			const fullWidthDotRegex = /[。．]/;
			for (let input of inputs) {

				input.setCustomValidity("");

				// USERNAME
				if (input.name === "username") {
					if (input.value.trim() === "") {
						input.setCustomValidity("ユーザー名を入力してください");
						input.reportValidity();
						return false;
					}

					if (!asciiRegex.test(input.value)) {
						input.setCustomValidity("ユーザー名は半角英数字のみ入力してください");
						input.reportValidity();
						return false;
					}
				}

				// EMAIL
				if (input.name === "email") {
					if (input.value.trim() === "") {
						input.setCustomValidity("メールアドレスを入力してください");
						input.reportValidity();
						return false;
					}

					if (input.value.length > 50) {
						input.setCustomValidity("メールアドレスは50文字以内で入力してください");
						input.reportValidity();
						return false;
					}

					if (!asciiRegex.test(input.value)) {
						input.setCustomValidity("メールアドレスは半角英数字のみ入力してください");
						input.reportValidity();
						return false;
					}

					if (!emailRegex.test(input.value)) {
						input.setCustomValidity("正しいメール形式で入力してください");
						input.reportValidity();
						return false;
					}
				}
			}
			return true;
		}

		/* =====================
		   BACK
		===================== */
		function goBack() {
			history.back();
		}
	</script>

</body>

</html>